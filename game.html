<!DOCTYPE html>
<html><body style="background: #6d6d6d">
<div id="game" style="width: 800px; margin: 0 auto"><p id="pos"></p></div>
<script src="libs/lightgl.js"></script>
<script src="libs/csg.js"></script>
<script src="libs/viewer.js"></script>
<script src="utils.js"></script>
<script src="shaders.js"></script>
<script src="render.js"></script>
<script src="terrain.js"></script>
<script src="car.js"></script>
<script>
var angle = 0;
var gl = GL.create();
var shaders = new Shaders();
var terrain = new LevelOne();
var car = new Car();
car.x = terrain.carStart;

//wasd, 87 65 83 68
var carState = { speed: 0, accelerate: false, brake: false, fuelAmount: 1, acceleration: 0, time: 0 };

function keyChange(code, pressed) { 
    if(code == 68) carState.accelerate = pressed; 
    if(code == 65) carState.brake = pressed; 
}

document.body.onkeydown = function(e) { keyChange(e.keyCode, true); }
document.body.onkeyup = function(e) { keyChange(e.keyCode, false); }

gl.onupdate = function(seconds) {
    carState.time += seconds;
    var lastSpeed = carState.speed;
    carState.accelerate = carState.accelerate && carState.fuelAmount > 0;
    carState.brake = carState.brake && carState.fuelAmount > 0;

    if(carState.accelerate) {
        carState.speed += 60 * seconds;
        carState.fuelAmount -= seconds / 20;
    }
    else if(carState.brake) {
        carState.speed -= 60 * seconds;
        carState.fuelAmount -= seconds / 20;
    }
    else {
        carState.speed *= 0.9;
        carState.fuelAmount -= seconds / 40;
    }

    if(carState.fuelAmount < 0)
        carState.fuelAmount = 0;

    var segment = Math.floor(car.x);
    var startHeight = terrain.ground.height[segment];
    var endHeight = terrain.ground.height[segment + 1];

    carState.speed += (startHeight - endHeight) * 500 * seconds;

    if(carState.speed > 100) carState.speed = 100;
    if(carState.speed < -100) carState.speed = -100; 


    car.x += carState.speed * seconds;
    if(car.x < 505) { car.x = 505 + 0.01; carState.speed = 1; }
    if(car.x > terrain.finishLine ) { car.x = terrain.endPoint; carState.speed = 0; }

    carState.acceleration = seconds == 0 ? 0 : (carState.speed - lastSpeed) / seconds;
    car.y = mix(startHeight, endHeight, car.x - segment);

    document.getElementById("pos").textContent = car.x;
};

setupRender();
document.getElementById("game").appendChild(gl.canvas);
gl.ondraw = render;
gl.animate();
</script>
</body>
</html>